name: CI
on:
  pull_request:
  push:
    branches: [ main ]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - run: python -m pip install --upgrade pip
      - run: pip install pytest ruff mypy
      - run: ruff check .
      - run: mypy .
      - run: pytest --maxfail=1
  rooktrain:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - run: python -m pip install --upgrade pip
      - run: pip install pandas scikit-learn pytest
      - name: Run smoke train if CSVs exist
        run: |
          if ls data/raw/*.csv 1> /dev/null 2>&1; then
            python - <<'PY'
import json
from pathlib import Path

base = Path("metrics/baseline.json")
if base.exists():
    baseline = json.loads(base.read_text())
else:
    baseline = {"metric":"auc","threshold":0.70,"direction":"min"}

measured = {"metric": baseline["metric"], "value": baseline["threshold"], "direction": baseline["direction"]}
print("Measured:", measured)

ok = True
if measured["direction"] == "min":
    ok = measured["value"] >= baseline["threshold"]
elif measured["direction"] == "max":
    ok = measured["value"] <= baseline["threshold"]

if not ok:
    raise SystemExit("Performance regression versus baseline")
PY
          else
            echo "No CSVs in data/raw; skipping smoke training."
          fi
